# docker-compose.local.yml
services:
  # n8n - auto1.azapfy.com.br
  n8n:
    image: n8nio/n8n:latest
    restart: unless-stopped
    ports:
      - '5678:5678'
    environment:
      NODE_ENV: production
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: 'true'
      # Rede / URLs
      N8N_HOST: ${N8N_HOST}
      N8N_PORT: ${N8N_PORT}
      N8N_PROTOCOL: ${N8N_PROTOCOL}
      WEBHOOK_URL: ${WEBHOOK_URL}
      N8N_SECURE_COOKIE: ${N8N_SECURE_COOKIE}
      TZ: ${TZ}

      # Segurança
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE}
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}
      N8N_DIAGNOSTICS_ENABLED: ${N8N_DIAGNOSTICS_ENABLED}

      # Banco (Postgres)
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${POSTGRES_DB_N8N}
      DB_POSTGRESDB_USER: ${POSTGRES_USER}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_POSTGRESDB_SCHEMA: ${DB_POSTGRESDB_SCHEMA}

      # Execuções em fila (Redis/Bull)
      EXECUTIONS_MODE: queue
      QUEUE_BULL_REDIS_HOST: redis_back
      QUEUE_BULL_REDIS_PORT: 6379
      QUEUE_BULL_REDIS_DB: ${REDIS_DB}
      QUEUE_BULL_REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes:
      - n8n_data:/home/node/.n8n
    labels:
      - "traefik.enable=true"
      # HTTP
      - "traefik.http.routers.n8n-http.rule=Host(`auto1.azapfy.com.br`)"
      - "traefik.http.routers.n8n-http.entrypoints=web"
      - "traefik.http.routers.n8n-http.middlewares=n8n-redirect"
      - "traefik.http.middlewares.n8n-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.n8n-redirect.redirectscheme.permanent=true"
      # HTTPS
      - "traefik.http.routers.n8n.rule=Host(`auto1.azapfy.com.br`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls=true"
      - "traefik.http.routers.n8n.tls.certresolver=letsencrypt"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
    networks:
      - azap_net

  n8n-worker:
    image: n8nio/n8n:latest
    restart: unless-stopped
    command: worker
    environment:
      NODE_ENV: production
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: 'true'
      # Rede / URLs
      N8N_HOST: ${N8N_HOST}
      N8N_PORT: ${N8N_PORT}
      N8N_PROTOCOL: ${N8N_PROTOCOL}
      WEBHOOK_URL: ${WEBHOOK_URL}
      N8N_SECURE_COOKIE: ${N8N_SECURE_COOKIE}
      TZ: ${TZ}

      # Segurança
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE}
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}
      N8N_DIAGNOSTICS_ENABLED: ${N8N_DIAGNOSTICS_ENABLED}

      # Banco (Postgres)
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${POSTGRES_DB_N8N}
      DB_POSTGRESDB_USER: ${POSTGRES_USER}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_POSTGRESDB_SCHEMA: ${DB_POSTGRESDB_SCHEMA}

      # Execuções em fila (Redis/Bull)
      EXECUTIONS_MODE: queue
      QUEUE_BULL_REDIS_HOST: redis_back
      QUEUE_BULL_REDIS_PORT: 6379
      QUEUE_BULL_REDIS_DB: ${REDIS_DB}
      QUEUE_BULL_REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - azap_net

  # Chatwoot Web - auto2.azapfy.com.br
  chatwoot-web:
    image: chatwoot/chatwoot:v4.4.0
    restart: unless-stopped
    environment:
      # postgres
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DATABASE=${CHATWOOT_DB_NAME}
      - POSTGRES_USERNAME=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      # redis
      - REDIS_URL=redis://redis_back:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      # storage
      - ACTIVE_STORAGE_SERVICE=amazon
      - S3_BUCKET_NAME=chatwoot-2
      - AWS_ACCESS_KEY_ID=${CHATWOOT_AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${CHATWOOT_AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=us-west-2
      - STORAGE_REGION=us-west-2

      # app
      - RAILS_ENV=production
      - FRONTEND_URL=https://auto2.azapfy.com.br
      - SECRET_KEY_BASE=${CHATWOOT_SECRET_KEY_BASE}
      # acesso 
      - ENABLE_ACCOUNT_SIGNUP=true
      # email 
      - MAILER_SENDER_EMAIL=Azapfy <danielalvesferraz04@gmail.com>
      - SMTP_DOMAIN=gmail.com
      - SMTP_ADDRESS=smtp.gmail.com
      - SMTP_PORT=587
      - SMTP_USERNAME=danielalvesferraz04@gmail.com
      - SMTP_PASSWORD=${CHATWOOT_SMTP_PASSWORD}
      - SMTP_AUTHENTICATION=login
      - SMTP_ENABLE_STARTTLS_AUTO=true
      - SMTP_OPENSSL_VERIFY_MODE=none
      - MAILER_INBOUND_EMAIL_DOMAIN=auto2.azapfy.com.br
      # Timeout
      - REQUEST_TIMEOUT=90
      - RACK_TIMEOUT_SERVICE_TIMEOUT=180
      - PUMA_WORKERS_TIMEOUT=180
    entrypoint: docker/entrypoints/rails.sh
    command: [ 'bundle', 'exec', 'rails', 's', '-b', '0.0.0.0', '-p', '3000' ]
    ports:
      - '0.0.0.0:3000:3000'  # Porta para acesso direto (teste)
    labels:
      - "traefik.enable=true"
      # HTTP
      - "traefik.http.routers.chatwoot-http.rule=Host(`auto2.azapfy.com.br`)"
      - "traefik.http.routers.chatwoot-http.entrypoints=web"
      - "traefik.http.routers.chatwoot-http.middlewares=chatwoot-redirect"
      - "traefik.http.middlewares.chatwoot-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.chatwoot-redirect.redirectscheme.permanent=true"
      # HTTPS
      - "traefik.http.routers.chatwoot.rule=Host(`auto2.azapfy.com.br`)"
      - "traefik.http.routers.chatwoot.entrypoints=websecure"
      - "traefik.http.routers.chatwoot.tls=true"
      - "traefik.http.routers.chatwoot.tls.certresolver=letsencrypt"
      - "traefik.http.services.chatwoot.loadbalancer.server.port=3000"
    networks:
      - azap_net

  # Chatwoot Worker
  chatwoot-worker:
    image: chatwoot/chatwoot:v4.6.0
    restart: unless-stopped
    environment:
      - SECRET_KEY_BASE=${CHATWOOT_SECRET_KEY_BASE}
      # postgres
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DATABASE=${CHATWOOT_DB_NAME}
      - POSTGRES_USERNAME=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      # redis
      - REDIS_URL=redis://redis_back:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      # storage
      - ACTIVE_STORAGE_SERVICE=amazon
      - S3_BUCKET_NAME=chatwoot-2
      - AWS_ACCESS_KEY_ID=${CHATWOOT_AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${CHATWOOT_AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=us-west-2
      - STORAGE_REGION=us-west-2
      - ENABLE_ACCOUNT_SIGNUP=true
      # email 
      - MAILER_SENDER_EMAIL=Azapfy <danielalvesferraz04@gmail.com>
      - SMTP_DOMAIN=gmail.com
      - SMTP_ADDRESS=smtp.gmail.com
  - SMTP_PORT=587
  - SMTP_USERNAME=danielalvesferraz04@gmail.com
  - SMTP_PASSWORD=${CHATWOOT_SMTP_PASSWORD}
      - SMTP_AUTHENTICATION=login
      - SMTP_ENABLE_STARTTLS_AUTO=true
      - SMTP_OPENSSL_VERIFY_MODE=none
      - MAILER_INBOUND_EMAIL_DOMAIN=auto2.azapfy.com.br
      - FRONTEND_URL=https://auto2.azapfy.com.br
      # Timeout
      - REQUEST_TIMEOUT=90
      - RACK_TIMEOUT_SERVICE_TIMEOUT=180
      - PUMA_WORKERS_TIMEOUT=180
    entrypoint: docker/entrypoints/rails.sh
    command: [ 'bundle', 'exec', 'sidekiq', '-C', 'config/sidekiq.yml' ]
    networks:
      - azap_net

  # Evolution API - auto3.azapfy.com.br
  evolution-api:
    image: evoapicloud/evolution-api:v2.3.4
    restart: unless-stopped 
    ports:
      - "8081:8080"  # Porta para acesso direto (teste)
    environment:
      - SERVER_URL=https://auto3.azapfy.com.br
      - DEL_INSTANCE=false
      # postgres
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/evolution_db
      - DATABASE_SAVE_DATA_INSTANCE=true
      - DATABASE_SAVE_DATA_NEW_MESSAGE=true
      - DATABASE_SAVE_MESSAGE_UPDATE=true
      - DATABASE_SAVE_DATA_CONTACTS=true
      - DATABASE_SAVE_DATA_CHATS=true
      - DATABASE_SAVE_DATA_LABELS=true
      - DATABASE_SAVE_DATA_HISTORIC=true
      - DATABASE_CONNECTION_CLIENT_NAME=evolution_v2
      # rabbitmq
      - RABBITMQ_ENABLED=false
      - RABBITMQ_URI=${RABBITMQ_URI}
      # Redis
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://:${REDIS_PASSWORD}@redis_back:6379/1
      - CACHE_REDIS_PREFIX_KEY=evolution_v2
      - CACHE_REDIS_SAVE_INSTANCES=false
      - CACHE_LOCAL_ENABLED=false
      # storage
      - S3_ENABLED=true
      - S3_ACCESS_KEY=${EVOLUTION_S3_ACCESS_KEY}
      - S3_SECRET_KEY=${EVOLUTION_S3_SECRET_KEY}
      - S3_BUCKET=evolution-api1
      - S3_PORT=443
      - S3_ENDPOINT=s3-us-west-2.amazonaws.com
      - S3_USE_SSL=true
      - S3_REGION=us-west-2

      # segurança
      - AUTHENTICATION_API_KEY=${EVOLUTION_AUTHENTICATION_API_KEY}
      # Qr Code
      - CONFIG_SESSION_PHONE_VERSION=2.3000.1023204200

      # chatwoot
      - CHATWOOT_ENABLED=true
      # Timeouts
      - HTTP_TIMEOUT=120000
      - MESSAGE_SEND_TIMEOUT=120000
      - CHATWOOT_MESSAGE_SEND_TIMEOUT=120000
      # Cache
      - CACHE_GROUP_PARTICIPANTS=true
      - CACHE_GROUP_TTL=3600
    labels:
      - "traefik.enable=true"
      # HTTP
      - "traefik.http.routers.evolution-http.rule=Host(`auto3.azapfy.com.br`)"
      - "traefik.http.routers.evolution-http.entrypoints=web"
      - "traefik.http.routers.evolution-http.middlewares=evolution-redirect"
      - "traefik.http.middlewares.evolution-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.evolution-redirect.redirectscheme.permanent=true"
      # HTTPS
      - "traefik.http.routers.evolution.rule=Host(`auto3.azapfy.com.br`)"
      - "traefik.http.routers.evolution.entrypoints=websecure"
      - "traefik.http.routers.evolution.tls=true"
      - "traefik.http.routers.evolution.tls.certresolver=letsencrypt"
      - "traefik.http.services.evolution.loadbalancer.server.port=8080"
    volumes:
      - evolution_data:/evolution/instances
    networks:
      - azap_net

volumes:
  n8n_data:
    driver: local
  evolution_data:
    driver: local

networks:
  azap_net:
    external: true
